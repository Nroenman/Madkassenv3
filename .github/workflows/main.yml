name: CI Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:

  # ------------------------------
  #   BACKEND TESTS (.NET)
  # ------------------------------
  backend-tests:
    name: Backend Tests (.NET)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install OS dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y sqlite3 libsqlite3-dev

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Restore
        working-directory: ./MadkassenRestAPI
        run: dotnet restore

      - name: Build
        working-directory: ./MadkassenRestAPI
        run: dotnet build --configuration Release --no-restore

      - name: Run tests
        working-directory: ./MadkassenTest
        run: dotnet test --configuration Release --verbosity normal



  # ------------------------------
  #   FRONTEND BUILD (React)
  # ------------------------------
  frontend-build:
    name: Frontend Build (React)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ./madkassenweb/package-lock.json

      - name: Install dependencies
        working-directory: ./madkassenweb
        run: npm ci

      - name: Build frontend
        working-directory: ./madkassenweb
        run: npm run build



  # ------------------------------
  #   PLAYWRIGHT E2E TESTS
  # ------------------------------
  playwright-e2e:
    name: Playwright E2E Tests
    runs-on: ubuntu-latest
    needs: [ backend-tests, frontend-build ]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Install global CLI tools
        run: npm install -g serve wait-on

      - name: Restore backend
        working-directory: ./MadkassenRestAPI
        run: dotnet restore

      - name: Install frontend dependencies
        working-directory: ./madkassenweb
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./madkassenweb
        run: npx playwright install --with-deps

      # üöÄ Start backend API in CI environment
      - name: Start backend API
        working-directory: ./MadkassenRestAPI
        env:
          ASPNETCORE_ENVIRONMENT: CI
          ASPNETCORE_URLS: http://0.0.0.0:5092
        run: |
          dotnet run --configuration Release --no-launch-profile > backend.log 2>&1 &
          sleep 20
          echo "=== Backend log (initial) ==="
          sed -n '1,200p' backend.log || true

      # ü©∫ Wait for backend
      - name: Wait for backend health
        run: |
          for i in {1..10}; do
            if curl -sSf http://localhost:5092/api/health > /dev/null; then
              echo "Backend is UP ‚úÖ"
              exit 0
            fi
            echo "Backend not up yet, retry $i..."
            sleep 3
          done

          echo "Backend FAILED to start ‚ùå"
          echo "=== Backend log (final) ==="
          sed -n '1,200p' MadkassenRestAPI/backend.log || true
          curl -v http://localhost:5092/api/health || true
          exit 1

      # Build frontend for E2E
      - name: Build frontend (for E2E)
        working-directory: ./madkassenweb
        run: npm run build

      # Serve static frontend
      - name: Start frontend static server
        working-directory: ./madkassenweb
        run: |
          serve -s build -l 3000 &
          wait-on http://localhost:3000

      # üß™ Run Playwright tests
      - name: Run Playwright tests
        working-directory: ./madkassenweb
        run: npx playwright test

  # ------------------------------
  #   POSTMAN API TESTS (Newman)
  # ------------------------------
  postman-api-tests:
    name: Postman API Tests
    runs-on: ubuntu-latest
    needs: [ backend-tests ]   # k√∏r f√∏rst n√•r backend build + tests er ok

    steps:
      - uses: actions/checkout@v4

      # .NET til at k√∏re backend
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      # Node til Newman
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Restore backend
      - name: Restore backend
        working-directory: ./MadkassenRestAPI
        run: dotnet restore

      #  Start backend API p√• samme URL som Postman bruger
      - name: Start backend API
        working-directory: ./MadkassenRestAPI
        env:
          ASPNETCORE_ENVIRONMENT: CI
          ASPNETCORE_URLS: https://localhost:7088
        run: |
          dotnet run --configuration Release --no-launch-profile > backend.log 2>&1 &
          sleep 15
          echo "=== Backend log (initial) ==="
          sed -n '1,80p' backend.log || true

      #  Vent p√• backend health (HTTPS + self-signed cert ‚Üí -k)
      - name: Wait for backend health
        run: |
          for i in {1..10}; do
            if curl -k -sSf https://localhost:7088/api/health > /dev/null; then
              echo "Backend is UP ‚úÖ"
              exit 0
            fi
            echo "Backend not up yet, retry $i..."
            sleep 3
          done

          echo "Backend FAILED to start ‚ùå"
          echo "=== Backend log (final) ==="
          sed -n '1,200p' MadkassenRestAPI/backend.log || true
          curl -k -v https://localhost:7088/api/health || true
          exit 1

      #  Install√©r Newman (Postman CLI)
      - name: Install newman
        run: npm install -g newman

      # üß™ K√∏r Postman collection
      - name: Run Postman tests
        run:  newman run Postman/Madkassen.postman_collection.json
